name: release-windows-v2

on:
  workflow_dispatch:

jobs:
  release-windows:
    runs-on: windows-2022
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      # Fail fast if signing sneaks back in
      - name: Verify signing is disabled
        shell: pwsh
        run: |
          $text = Get-Content src-tauri/tauri.conf.json -Raw
          if ($text -match '"signCommand"\s*:') {
            Write-Error 'Found "signCommand" in tauri.conf.json. Remove it to build unsigned.'
          }
          if ($text -match '"createUpdaterArtifacts"\s*:\s*true') {
            Write-Error 'createUpdaterArtifacts is true; set it to false for unsigned builds.'
          }
          if ($text -match '"plugins"\s*:\s*\{\s*"updater"') {
            Write-Error 'plugins.updater is present; remove it for unsigned builds.'
          }

      # Read version from tauri.conf.json so we can reuse the tag later
      - name: Read app version
        id: meta
        shell: pwsh
        run: |
          $cfg = Get-Content src-tauri/tauri.conf.json -Raw | ConvertFrom-Json
          $v = $cfg.version
          "version=$v" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      # Build and PUBLISH the Release; tauri-action uploads all bundles it finds (NSIS installer, etc.)
      - name: Build and publish Release (unsigned)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: v${{ steps.meta.outputs.version }}
          releaseName: 'v${{ steps.meta.outputs.version }}'
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: false          # publish immediately
          prerelease: false
          args: --target x86_64-pc-windows-msvc --verbose

      # Optionally attach the raw .exe (unbundled) to the same Release tag
      - name: Upload raw .exe to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.meta.outputs.version }}
          files: |
            src-tauri/target/x86_64-pc-windows-msvc/release/Rclone UI.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # (Optional) Show what got built
      - name: List built files
        shell: pwsh
        run: |
          $out = "$env:GITHUB_WORKSPACE\src-tauri\target\x86_64-pc-windows-msvc\release"
          Write-Host "Release dir: $out"
          Get-ChildItem -Recurse -File $out | Select-Object FullName, Length | Format-Table -AutoSize
